---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { getEntry, getCollection } from "astro:content";

export async function getStaticPaths() {
  const { getCollection } = await import("astro:content");
  const essays = await getCollection("essays");
  return essays.map((entry) => ({
    params: { slug: entry.slug },
  }));
}

const { slug } = Astro.params;
const entry = await getEntry("essays", slug!);

if (!entry) return Astro.redirect("/essays");

const { Content } = await entry.render();

// Get all published essays sorted by date for prev/next navigation
const allEssays = (await getCollection("essays"))
  .filter(e => !e.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const currentIndex = allEssays.findIndex(e => e.slug === slug);
const previousEssay = currentIndex < allEssays.length - 1 ? allEssays[currentIndex + 1] : null;
const nextEssay = currentIndex > 0 ? allEssays[currentIndex - 1] : null;
---

<SiteLayout title={`${entry.data.title} — Age of Wonders`} description={entry.data.description}>
  <h1 style="margin-top: 0; margin-bottom: 12px;">{entry.data.title}</h1>
  {entry.data.description && (
    <p style="font-style: italic; font-size: 21px; color: var(--muted); margin-bottom: 8px; line-height: 1.5;">
      {entry.data.description}
    </p>
  )}
  <p class="meta" style="margin-top: 12px; margin-bottom: 48px;">
    {entry.data.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
  </p>
  
  <Content />

  <!-- Subscribe CTA -->
  <div style="margin-top: 64px; padding: 32px; background: linear-gradient(to right, var(--accent-light), transparent); border-left: 4px solid var(--accent); border-radius: 0 6px 6px 0;">
    <h3 style="margin: 0 0 12px 0; font-size: 26px; font-weight: 500; color: var(--text);">Explore More</h3>
    <p style="margin: 0 0 20px 0; font-size: 20px; line-height: 1.6; color: var(--text-light);">
      Read new essays exploring abundance, access, and the Age of Wonders ahead.
    </p>
    <a 
      href="/subscribe" 
      style="display: inline-block; padding: 12px 28px; background: var(--accent); color: white; text-decoration: none; border-radius: 6px; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 16px; letter-spacing: 0.3px; transition: all 0.2s ease;"
      onmouseover="this.style.background='#0052a3'"
      onmouseout="this.style.background='var(--accent)'"
    >
      Subscribe
    </a>
    <p style="margin: 16px 0 0 0; font-family: 'Inter', sans-serif; font-size: 15px; color: var(--muted); font-style: italic;">
      Low frequency. High quality. No distractions.
    </p>
  </div>

  <!-- Essay Navigation -->
  <nav style="margin-top: 80px; padding-top: 32px; border-top: 1px solid var(--rule); display: flex; justify-content: space-between; align-items: center; gap: 32px;">
    <div style="flex: 1;">
      {previousEssay ? (
        <a href={`/essays/${previousEssay.slug}/`} style="text-decoration: none; display: block;">
          <span style="font-family: 'Inter', sans-serif; font-size: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">← Previous</span>
          <span style="font-size: 20px; color: var(--text); font-weight: 500;">{previousEssay.data.title}</span>
        </a>
      ) : null}
    </div>
    <div style="flex: 1; text-align: right;">
      {nextEssay ? (
        <a href={`/essays/${nextEssay.slug}/`} style="text-decoration: none; display: block;">
          <span style="font-family: 'Inter', sans-serif; font-size: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Next →</span>
          <span style="font-size: 20px; color: var(--text); font-weight: 500;">{nextEssay.data.title}</span>
        </a>
      ) : null}
    </div>
  </nav>
</SiteLayout>